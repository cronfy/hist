---
layout: single
classes: wide
title:  "Как вести блог в формате git?"
date:   2021-03-06 13:45:00 +0300
categories: v1
---
Решил попробовать сделать запись для блога в git. И тут как начали появляться вопросы, как начали появляться вопросы!

Пост-размышление.

---

Нужно подумать, что нужно учесть при ведении блога в формате репозитория git.

Итак.

Основные моменты понятны - берешь да ведёшь. Есть github.io для публикации. Есть Jekyll и аналоги.

## Структурирование информации и изменения структуры (редиректы)

Вопрос в структурировании информации и постоянных ссылках на неё. Если контент будет добавляться, то рано или поздно его захочется структурировать. Плоский список по дате создания неудобен, так как не решает задачу поиска нужной информации, когда вспомнил "я что-то такое писал об X, дай-ка посмотрю".

Соответственно, нужна иерархическая структура контента, не важно суть сейчас какая, главное, что она будет.

Однако рано или поздно любая структура перестает нравиться и хочется её кардинально изменить.

И в такой момент я не хочу вспоминать, в каких местах я оставлял ссылки на контент и могу ли я ими пожертвовать? Или я должен там отредактировать ссылку? Или нужно сделать редирект? Или придется оставить старую? Я не хочу после этого махать рукой "ай, ладно, проще в старой структуре все хранить". Я хочу просто поменять структуру как мне удобно, не беспокоясь о том, что какие-то ссылки побьются. Хочу, чтобы изменение структуры происходило Без, Проб, Лем.

Когда-нибудь мне может быть также захочется поменять структуру внешних URL. Ну мало ли. Или я буду вынужден сделать это по каким-то причинам. Соответственно, это не должно вызывать сложности - составил линковку старых ссылок на новые, сделал редиректы и вперед. (Сам процесс составления линковки не должен вызывать сложности).

Я думаю, решить эту проблему можно таким способом расположения контента:

Папка content/ — здесь хранится контент (не публикуется, только хранится). Содержит контент в любой структуре, в которой удобно. Ссылок сюда не даём. Это такой раздел с исходником информации.

 * `content/любая/структура/как/сейчас/удобно/хранить/контент/Пост_1` - пост 1, содержит файлы content.md и .metadata
 * `content/любая/структура/как/сейчас/удобно/хранить/контент/Пост_2` - аналогично, пост 2

Папка public/ — здесь публикуется контент

 * **public/v1/** - первая версия структуры внешних URL (любая структура внешних URL)
 * `public/v1/post1/` - Пост 1, содержит файлы index.html и .metadata
 * `public/v1/post2/`
 * **public/v2/** - вторая версия структуры внешних URL (любая другая структура внешних URL)
 * `public/v2/blog/2021-03-06-how-to-blog-in-git.html` - Пост 1
 * `public/v2/programming/2021-02-18-phpstorm-is-cool.html` - Пост 2

Изначально делаем **public/v1/**, и в ней размещаем посты методом копирования контента из content/. Оставляем мета-данные - из каких недр content'а нужно брать информацию сюда. В принципе, руками ничего копировать не надо - задачу решает автоматический генератор.

Ссылки так и будут выглядеть: myblog.example.com/v1/... . Наверное, это единственный неприятный сайд-эффект от такой схемы. Но вместо v1, v2... можно писать что-нибудь веселенькое.

Если мы решили поменять структуру внешних ссылок public/, то создаем новую папку *public/v2/*, настраиваем для неё генератор, чтобы публиковал посты по новой структуре, генерируем посты. После этого с предыдущей версии public/v1/ можно сделать редиректы на новую. Так как и в прежней и в новой версии public/ мы имеем ссылки на один и тот же content/, это будет несложно сделать.

И тут важно отметить, что ссылкой, которую мы можем редиректить, может быть только html-файл (в связи с ограничениями github.io). А например, если у поста есть ресурс в виде приаттаченного doc-файла, то редирект для него сделать не получится. Так что, чтобы все упростить, ограничим наше стремление сохранять ссылки при перемещении только для постов (и договоримся, что если размещаем где-то ссылку на блог, то это должна быть ссылка именно на пост, а не на ресурс этого поста).

Со сменой URL понятно, теперь про смену структуры контента. Тут тоже несложно.

Если мы решили поменять структуру content/ - сохраняем у каждого контента метаданные, где он лежит сейчас, перераспределяем все по новым папкам, составляем карту линковки старое -> новое, проходимся по метаданным public/v.../, перебиваем старую линковку (это которая в метаданных) на content/ на новую.

Вот. Как-то так. Кто-то скажет: избыточность, а я скажу: зато гибко.

## Комментарии в тексте

В тексте поста время от времени возникает желание сделать комментарий. Исходный формат статьи Markdown.

Вопрос: как оставлять комментарии в Markdown?

При этом речь не идет о каком-то супер-секретном комментарии. В любом случае репозиторий блога публичный.
Даже если комментария не будет в срендеренном HTML, его легко можно посмотреть в исходнике на github.
Цель только в том, чтобы оставить коммент (навроде todo), который не будет мешать читать пост.

В спецификации Markdown комментариев нет. 

Ответ есть в [этой статье на SO](https://stackoverflow.com/questions/4823468/comments-in-markdown).

Там предложено много вариантов, например, способ,
[подходящий для использования внутри списков github](https://stackoverflow.com/a/29724376). 

Ниже же - список способов, которые я реально буду
использовать, и здесь же можно будет протестировать совместимость при смене движка 
Markdown.

### Тест варианта HTML

Код (третий дефис не понял зачем, но говорят, что надо):

```markdown
<!---
строка 1

строка 2
-->
```

Тест (ничего не должно вывестись):

<!--
строка 1

строка 2
-->

Текст после комментария (выше не должно быть заметно, как будто там что-то было).

Текст после текста (для сравнения).

### Тест варианта URL

Код:

```markdown
[//]: # (Тут текст комментария)
[//]: # (Многострочность через повторение)
[//]: # (Перед и после комментария нужна пустая строка)
```

Тест (ничего не должно вывестись):
 
[//]: # (Тут текст комментария)
[//]: # (Многострочность через повторение)
[//]: # (Перед и после комментария нужна пустая строка)

Текст после комментария (выше не должно быть заметно, как будто там что-то было).

Ну, вроде работает.

## Редиректы на github.io

Как ты сделаешь редирект в условиях github.io?

### Вариант 1: meta refreh в index.html

Например, [созданием index.html с meta refresh](https://gist.github.com/domenic/1f286d415559b56d725bee51a62c24a7).  

Из чего следует, что все страницы, которые ты потенциально можешь захотеть редиректнуть,
должны быть `*.html`.

### Вариант 2: симлинки

Как оказалось, [Github Pages поддерживает симлинки](https://github.com/chetabahana/symlink). 

Это значит, что можно обойтись вообще без редиректов - просто делать симлинк со старой папки поста на новое место публикации. Контент будет открываться и по старым, и по новым ссылкам. Нужно также следить, чтобы корректно генерировался canonical.

## Редакторы для Markdown

 * PHPStorm - хорошо, но баги, может поправят.
 * ReText - не совсем как на github, [чтобы поменять flavor нужно ставить pip'ом расширения](https://github.com/retext-project/retext/issues/369)... брр. 
 * Atom - глючит, падает, вместо preview выводит странные эксепшены.
 * Sublime + MarkdownPreview - как-то тоже не очень.. результат приходится смотреть в браузере. Зато рендерит самим github'ом это в целом неплохо.
 * Ghosttext пока не пробовал, инфа [тут](https://ru.stackoverflow.com/questions/549184/%D0%9A%D0%B0%D0%BA-%D0%B2-sublime-text-%D1%81%D0%B4%D0%B5%D0%BB%D0%B0%D1%82%D1%8C-live-preview-%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%82%D0%BA%D0%B8-markdown).  
